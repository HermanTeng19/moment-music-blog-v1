<!DOCTYPE html>
<html>
<head>
    <title>Cloudflare R2 CORS测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        audio {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Cloudflare R2 CORS配置测试</h1>
    
    <div class="test-section">
        <h2>测试1: 基本音频播放</h2>
        <p>测试音频文件是否可以通过自定义域名播放</p>
        <audio controls crossorigin="anonymous">
            <source src="https://music.aibytes.dpdns.org/1001%20Not%20All%20Heroes%20Wear%20Capes.mp3" type="audio/mpeg">
            您的浏览器不支持音频播放
        </audio>
        <div id="audio-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试2: Fetch请求</h2>
        <p>测试跨域请求是否被CORS策略允许</p>
        <button onclick="testFetch()">测试Fetch请求</button>
        <div id="fetch-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试3: AudioContext</h2>
        <p>测试音频分析功能是否正常工作</p>
        <button onclick="testAudioContext()">测试音频分析</button>
        <div id="audiocontext-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试4: URL编码验证</h2>
        <p>测试带空格的文件名URL编码</p>
        <button onclick="testURLEncoding()">测试URL编码</button>
        <div id="url-result" class="result"></div>
    </div>

    <script>
        // 监听音频加载事件
        const audio = document.querySelector('audio');
        
        audio.addEventListener('loadstart', () => {
            document.getElementById('audio-result').innerHTML = 
                '<div class="success">✅ 音频开始加载</div>';
        });
        
        audio.addEventListener('loadedmetadata', () => {
            document.getElementById('audio-result').innerHTML += 
                '<div class="success">✅ 音频元数据加载成功</div>';
        });
        
        audio.addEventListener('canplay', () => {
            document.getElementById('audio-result').innerHTML += 
                '<div class="success">✅ 音频可以播放</div>';
        });
        
        audio.addEventListener('error', (e) => {
            document.getElementById('audio-result').innerHTML += 
                `<div class="error">❌ 音频加载失败: ${e.message}</div>`;
        });

        async function testFetch() {
            const resultDiv = document.getElementById('fetch-result');
            resultDiv.innerHTML = '<div>正在测试...</div>';
            
            try {
                const response = await fetch('https://music.aibytes.dpdns.org/1001%20Not%20All%20Heroes%20Wear%20Capes.mp3', {
                    method: 'HEAD'
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">✅ Fetch成功: ${response.status} ${response.statusText}</div>`;
                    
                    // 显示CORS头信息
                    const corsHeaders = {
                        'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                        'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                        'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                    };
                    
                    resultDiv.innerHTML += '<div class="success">CORS头信息:</div>';
                    for (const [key, value] of Object.entries(corsHeaders)) {
                        if (value) {
                            resultDiv.innerHTML += `<div class="success">${key}: ${value}</div>`;
                        }
                    }
                    
                    console.log('CORS头信息:', corsHeaders);
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Fetch失败: ${response.status}</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Fetch错误: ${error.message}</div>`;
                console.error('Fetch详细错误:', error);
            }
        }
        
        async function testAudioContext() {
            const resultDiv = document.getElementById('audiocontext-result');
            resultDiv.innerHTML = '<div>正在测试...</div>';
            
            try {
                const audio = document.querySelector('audio');
                
                // 确保音频已加载
                if (audio.readyState < 2) {
                    resultDiv.innerHTML = '<div class="error">❌ 请先播放音频以加载元数据</div>';
                    return;
                }
                
                // 创建AudioContext
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaElementSource(audio);
                const analyser = audioContext.createAnalyser();
                
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // 测试频率数据
                const frequencyData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(frequencyData);
                
                resultDiv.innerHTML = '<div class="success">✅ AudioContext配置成功</div>';
                resultDiv.innerHTML += `<div class="success">✅ 频率数据长度: ${frequencyData.length}</div>`;
                resultDiv.innerHTML += '<div class="success">✅ 音频分析功能正常</div>';
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ AudioContext失败: ${error.message}</div>`;
                console.error('AudioContext详细错误:', error);
            }
        }
        
        function testURLEncoding() {
            const resultDiv = document.getElementById('url-result');
            
            const originalFilename = '1001 Not All Heroes Wear Capes.mp3';
            const encodedFilename = encodeURIComponent(originalFilename);
            const expectedURL = `https://music.aibytes.dpdns.org/${encodedFilename}`;
            const currentURL = 'https://music.aibytes.dpdns.org/1001%20Not%20All%20Heroes%20Wear%20Capes.mp3';
            
            resultDiv.innerHTML = `
                <div class="success">原始文件名: ${originalFilename}</div>
                <div class="success">编码后: ${encodedFilename}</div>
                <div class="success">期望URL: ${expectedURL}</div>
                <div class="success">当前URL: ${currentURL}</div>
            `;
            
            if (expectedURL === currentURL) {
                resultDiv.innerHTML += '<div class="success">✅ URL编码正确</div>';
            } else {
                resultDiv.innerHTML += '<div class="error">❌ URL编码不匹配</div>';
            }
        }
    </script>
</body>
</html>
